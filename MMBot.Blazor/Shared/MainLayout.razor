@inject IAccountService AccountService
@inject NavigationManager NavigationManager
@inject StateContainer StateContainer
@implements IDisposable

@inherits LayoutComponentBase
<MudThemeProvider />

<MudLayout>
    <MudAppBar Elevation="2">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudText Typo="Typo.h5" Class="ml-3">MMBot</MudText>

        <AuthorizeView>
            <Authorized>
                <MudGrid>
                    <MudItem xs="12">
                        <MudGrid Spacing="5" Justify="Justify.FlexEnd">
                            <MudItem>
                                <MudText Typo="Typo.h6" Class="ml-3">Hello, @context.User.Identity.Name!</MudText>
                            </MudItem>
                            <MudItem>
                                <MudSelect T="string" @onchange="OnSelectedGuildChanged" Label="Guild">
                                    @foreach (var guild in AccountService.LoggedUser.Guilds)
                                    {
                                        <MudSelectItem T="string" value="@guild.id">@guild.name</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem>
                                <MudLink Typo="Typo.h6" Class="ml-3" Color="Color.Inherit" Href="Account/Logout">Log out</MudLink>
                            </MudItem>
                        </MudGrid>
                    </MudItem>
                </MudGrid>
            </Authorized>
            <NotAuthorized>
                <MudGrid>
                    <MudItem xs="12">
                        <MudGrid Spacing="5" Justify="Justify.FlexEnd">
                            <MudItem>
                                <MudLink Typo="Typo.h6" Class="ml-3" Href="Account/Login">Log in</MudLink>
                            </MudItem>
                        </MudGrid>
                    </MudItem>
                </MudGrid>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <MudPaper Width="Auto" Class="py-3" Square="true">
            <MudNavMenu>
                <MudDivider Class="my-2" />
                <MudNavLink Href="" Match="NavLinkMatch.All">Home</MudNavLink>
                <MudNavGroup Title="Data" Expanded="true">
                    <MudNavLink Href="clan">Clan</MudNavLink>
                    <MudNavLink Href="member">Member</MudNavLink>
                </MudNavGroup>
                <MudNavLink Href="/about">About</MudNavLink>
            </MudNavMenu>
        </MudPaper>
    </MudDrawer>
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>

@code
{
    bool _drawerOpen = true;

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    public string SelectedGuild { get; set; }

    public void OnSelectedGuildChanged(ChangeEventArgs args)
    {
        StateContainer.SetSelectedGuildId(args.Value?.ToString());
    }

    protected override void OnInitialized()
    {
        StateContainer.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        StateContainer.OnChange -= StateHasChanged;
    }
}
